@model IEnumerable<Fashion.ERP.Web.Areas.Almoxarifado.Models.GridMaterialModel>

<div id="modal-material" class="modal hide fade">
    
    <div class="modal-header">
        <a href="javascript:void(0)" class="close" data-dismiss="modal" aria-hidden="true">&times;</a>
        <h3>Pesquisar material</h3>
    </div>
    @using (Html.BeginForm(MVC.Almoxarifado.Material.Pesquisar()))
    {
        @Html.AntiForgeryToken()
        <div id="modal-body-material" class="modal-body" style="overflow-y: hidden;">
            <div class="width100 clearfix">
                @Html.DropDownList("ColunaPesquisa", null, new {@class = "pull-left input-medium"})
                <input name="ValorPesquisa" class="pull-left input-xlarge" type="text" />
                <input name="ParametroFornecedorMaterial" id="FornecedorMaterial" type="hidden" /> 
                <input name="FiltroTipoItemMaterial" type="hidden"/>
                <input id="submit-pesquisar-material" type="button" value="Pesquisar" class="btn input-mini pull-right" />
            </div>
            <div id="grid-pesquisa-material"></div>
        </div>
    }
    <div class="modal-footer">
        <button type="button" class="btn" data-dismiss="modal" aria-hidden="true">Cancelar</button>
        <button id="selecionar-material" class="btn btn-primary" type="button">Selecionar</button>
    </div>
</div>
<script>
    $(function () {

        $('#submit-pesquisar-material').off('click').on('click', function (e) {
            var form = $(this).closest("form");
            
            form.ajaxSubmit({
                dataType: 'json',
                cache: false,
                url: "@Html.GetUrl(MVC.Almoxarifado.Material.PesquisarFiltro())",
                beforeSubmit: function() {
                    e.preventDefault();
                },
                success: function (data) {
                    if (data.Error) {
                        alert(data.Error);
                        return;
                    }

                    $(this).children(':submit').button('reset');
                
                    var grid = $("#grid-pesquisa-material").kendoGrid({
                        height: "380px",
                        selectable: "row",
                        columns: [
                            { field: "Id", hidden: true },
                            { field: "Referencia", title: "Referência" },
                            { field: "Descricao", title: "Descrição", width: 400 },
                            { field: "ReferenciaExterna", hidden: true },
                            { template: '<input id="checked" type="checkbox"/>', width: 30 }
                        ],
                        dataSource: data
                    });
                    if(grid.find("th:last input").get(0) == null) {
                        grid.find("th:last")
                            .append($('<input class="selectAll" type="checkbox"/>'))
                            .delegate(".selectAll", "click", function () {
                                var checkbox = $(this);
                                grid.find("tr")
                                    .find("td:last input")
                                    .attr("checked", checkbox.is(":checked"))
                                    .trigger("change");
                            });

                        grid.delegate($("tbody>tr"), "click", function (ev) {
                            var linha = $(ev.target).closest('tr');
                            if (!$(event.target).is("input")){
                                var checkbox = linha.find("td:last input");
                                checkbox.prop("checked", !checkbox.prop("checked")).trigger("change");
                            }
                            grid.select(linha);
                        });
                    }
                },
            });

            return false;
        });
            
        $('#pesquisarvarios-material').on('click', function () {
            $('#modal-material').modal('show').one('hidden', function () {
                $('#ColunaPesquisa')[0].selectedIndex = 0;
                $('input[name$="ValorPesquisa"]').val('');
                $('#grid-pesquisa-material').empty();
            });
        });
        
        $('#selecionar-material').on('click', selecionarMaterial);
        
        function selecionarMaterial() {
            var grid = $('#grid-pesquisa-material').data("kendoGrid");
            var dataItemsAll = grid.dataItems();
            var dataItemsSelecinados = [];
            for (var i in dataItemsAll) {
                var dataItem = dataItemsAll[i];
                var row = grid.tbody.find("tr[data-uid='" + dataItem.uid + "']");

                if (row.find("#checked").prop("checked")) {
                    dataItemsSelecinados.push(dataItem);
                }
            }

            $('#modal-material').modal('hide');

            if (!grid) return;
            
            $("#selecionar-material").trigger("pesquisar", { DataItemsSelecionados : dataItemsSelecinados});
        }        
    });

    function configureParametroPesquisarVariosMateriaisPorTipoItem(idTipoItem) {
        $("#ParametroTipoItemMaterial").val(idTipoItem);
    }

    function configureParametroPesquisarVariosMateriaisPorFornecedor(idFornecedor) {
        $("#ParametroFornecedorMaterial").val(idFornecedor);
    }
    
</script>