@model Fashion.ERP.Web.Areas.EngenhariaProduto.Models.VariacaoModeloModel

<hr/>
<div class="detail">
    <div class="row">
        <div class="span3">
            <div class="control-group">
                @Html.LabelFor(x => x.ModeloReferencia, new { @class = "title-label" })
                <div class="value-label">
                    @Html.ValueFor(x => x.ModeloReferencia)
                </div>
            </div>
            <div class="control-group">
                @Html.LabelFor(x => x.ModeloDescricao, new { @class = "title-label" })
                <div class="value-label">
                    @Html.ValueFor(x => x.ModeloDescricao)
                </div>
            </div>
        </div>
        <div class="span3">
            <div class="control-group">
                @Html.LabelFor(x => x.ModeloEstilistaNome, new { @class = "title-label" })
                <div class="value-label">
                    @Html.ValueFor(x => x.ModeloEstilistaNome)
                </div>
            </div>
            <div class="control-group">
                @Html.LabelFor(x => x.ModeloDataCriacao, new { @class = "title-label" })
                <div class="value-label">
                    @Html.ValueFor(x => x.ModeloDataCriacao)
                </div>
            </div>
        </div>
    </div>
</div>
<hr/>

@using (Html.BeginForm(MVC.EngenhariaProduto.Modelo.Variacao(), FormMethod.Post, new { id = "form", @class = "form-horizontal", novalidate = "novalidate" }))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummaryEx()
    @Html.HiddenFor(x => x.ModeloId)
    @Html.HiddenFor(x => x.ModeloReferencia)
    @Html.HiddenFor(x => x.ModeloDescricao)
    @Html.HiddenFor(x => x.ModeloEstilistaNome)
    @Html.HiddenFor(x => x.ModeloDataCriacao)

    <div class="row">
        <div class="span6">
            <div class="control-group">
                <label class="control-label">Variação</label>
                <div class="controls">
                    @Html.DropDownList("Variacao", null, "-- Selecione --", new { @class = "input-large" })
                    @Html.ValidationMessage("Variacao", new { @class = "help-block" })
                </div>
            </div>
            <div class="control-group">
                <label class="control-label">Cor</label>
                <div class="controls">
                    @Html.DropDownList("Cor", null, "-- Selecione --", new { @class = "input-large" })
                    <button id="btn-add" type="button" class="btn"><i class="icon-plus"></i></button>
                    @Html.ValidationMessage("Cor", new { @class = "help-block" })

                    <table id="table-variacao" class="table table-striped table-condensed" style="width: 250px">
                        <thead>
                            <tr>
                                <th></th>
                                <th style="width: 100px"></th>
                                <th style="width: 16px"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Variacoes != null)
                            {
                                long variacaoid = 0;
                                
                                for (int i = 0; i < Model.Variacoes.Count; i++)
                                {
                                    var cor = Model.Cores[i];
                                    
                                    <tr>
                                        @if (variacaoid != Model.Variacoes[i].Value)
                                        {
                                            variacaoid = Model.Variacoes[i].Value;
                                            
                                            <td rowspan="@Model.Variacoes.Count(s => s == variacaoid)">
                                                @(ViewBag.VariacoesDicionario[variacaoid])
                                            </td>
                                        }

                                        <td>
                                            @(ViewBag.CoresDicionario[cor])
                                            <input type="hidden" name="Variacoes" value="@Model.Variacoes[i]" />
                                            <input type="hidden" name="Cores" value="@cor" />
                                        </td>
                                        <td><a href="javascript:void(0)" onclick="Delete(this)"><i class="icon-remove"></i></a></td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>
    
    <div class="form-actions">
        <button id="btnSubmit" class="btn btn-primary" type="submit" data-loading-text="Aguarde...">Salvar</button>
    </div>
}
<script>
    $(document).ready(function () {
        
        $('#Variacao').rules("add", {
            required: true,
            maxlength: 100,
            messages: {
                required: "Informe a variação",
                maxlength: jQuery.format("Variação não deve ser maior que {0} caracteres")
            }
        });

        $('#Cor').rules("add", {
            required: true,
            messages: {
                required: "Informe a cor"
            }
        });

        $('#btn-add').on('click', function () {
            
            // Validar
            var form = $(this).closest("form");
            
            if (!form.valid()) {
                return;
            }

            var corId = $('#Cor').val();
            var cor = $('#Cor option:selected').text();
            var variacao = $('#Variacao option:selected').text();

            var variacaoId = $('#Variacao').val();
            var variacoes = $('input[name=Variacoes]').map(function () {
                return this.value;
            }).get();

            var duplicado = false;

            // Verificar se já tem uma cor para esta variação
            $('input[name=Cores]').each(function (index) {

                if (variacoes[index] == variacaoId) {
                    if ($(this).val() == corId) {
                        alert("A cor escolhida já está cadastrada.");
                        duplicado = true;
                        return;
                    }
                }
                
            });
            
            // Adiciona apenas se não existir
            if (duplicado == false) {
                
                var idxVariacao = jQuery.inArray(variacaoId, variacoes);
                if (idxVariacao == -1) {

                    // Se não existir variação, criá-la com a td:rowspan
                    $('#table-variacao tbody').append(
                    '<tr>\
                        <td rowspan="1">' + variacao + '</td>\
                        <td>' + cor + '<input type="hidden" name="Cores" value="' + corId + '"/>\
                            <input type="hidden" name="Variacoes" value="' + variacaoId + '"/></td>\
                        <td><a href="javascript:void(0)" onclick="Delete(this)"><i class="icon-remove"></i></a></td>\
                    </tr>');
                    
                } else {
                    // se existir, adicioná-la ao fim do grupo
                    var row = $($('#table-variacao tbody tr').get(idxVariacao));
                    
                    // Adiciona 1 ao rowspan, e retorna seu valor
                    var lastIdx = row.find('td[rowspan]').attr('rowspan', function (i, rs) { return rs.toNumber() + 1; }).attr('rowspan').toNumber();

                    var lastRow = $($('#table-variacao tbody tr').get(idxVariacao + lastIdx - 2));
                    lastRow.after('<tr>\
                            <td>' + cor + '<input type="hidden" name="Cores" value="' + corId + '"/>\
                                <input type="hidden" name="Variacoes" value="' + variacaoId + '"/></td>\
                            <td><a href="javascript:void(0)" onclick="Delete(this)"><i class="icon-remove"></i></a></td>\
                        </tr>');
                }
                
            }

        });

    });

    function Delete(a) {

        // Seleciona a linha a ser excluída
        var row = $(a).parent().parent();

        if (row.find('td[rowspan]').exists()) {

            // A linha excluída é o próprio rowspan
            // Então, mover o rowspan para a próxima linha, se houver
            var nextrow = row.next();
            if (nextrow != undefined && nextrow.has("td[rowspan]").exists() == false) {
                var tdrowspan = row.find('td[rowspan]').attr('rowspan', function (i, rs) { return rs - 1; });
                nextrow.prepend(tdrowspan);
            }

        } else {

            // Seleciona a linha que possui o rowspan e diminui o índice em 1
            row.prevAll('tr:has(td[rowspan]):first')
                .find('td[rowspan]')
                .attr('rowspan', function (i, rs) { return rs - 1; });

        }

        row.remove();
    }
</script>
